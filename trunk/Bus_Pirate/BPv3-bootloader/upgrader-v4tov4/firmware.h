/*
 * This file is part of the Bus Pirate project (http://code.google.com/p/the-bus-pirate/).
 *
 * Written and maintained by the Bus Pirate project.
 *
 * To the extent possible under law, the project has
 * waived all copyright and related or neighboring rights to Bus Pirate. 
 *
 * For details see: http://creativecommons.org/publicdomain/zero/1.0/.
 *
 *    This program is distributed in the hope that it will be useful,
 *    but WITHOUT ANY WARRANTY; without even the implied warranty of
 *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 */

//set the location where the new bootloader should be written
//is used for the write location, and to write the jump instruction at location 0x0000
#ifndef __DEBUG
	#define FWLOCATION	0xA800 //actual last page
#else // use a safe location for now :D since i don't have a proper programmer (someone wants to send me one?? :P)
	#define FWLOCATION	0x9000 
#endif

//this is the jump to bootloader address. 
//at end of upgrade the program will jump straight to the new bootloader
//this must be defined in asm
asm (".equ BLJUMPADDRESS, 0xABF8");

//define the location in the firmware array where the version is stored
//used to tell the user what version they're upgrading to
#define FWBLVERLOC_MAJ		1529		// location where version number (major) is stored
#define FWBLVERLOC_MIN		1528		// location where version number (minor) is stored


// test firmware (size should be exactly 1 page!)
// replace with the right bootloader
//export the page containing the firmware from MPLAB as a HEX
// convert the HEX to a byte array with the .html javascript converter
//if the bootloader is in the last page (Bus Pirate) don;t forget the config words
const unsigned char firmware [512*3] = {
0x20, 0x2F, 0x8C, 0xA9, 0x42, 0x27, 0xA9, 0x45, 0x07, 0xAE, 0x42, 0xA7,   // 0
0x37, 0xFE, 0xFF, 0x2F, 0xF0, 0xFF, 0x88, 0x60, 0x19, 0xA9, 0xCC, 0x22,   // 1
0xA8, 0xC8, 0x22, 0xA8, 0x68, 0xA0, 0xA9, 0xCC, 0x02, 0xA9, 0xC8, 0x02,   // 2
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xAF, 0xCA, 0x22, 0x37, 0xA0, 0x00,   // 3
0xEB, 0x00, 0x04, 0x80, 0x26, 0x35, 0x80, 0x27, 0x36, 0xA8, 0xA4, 0x06,   // 4
0xA9, 0xA4, 0x26, 0xA8, 0xA4, 0x46, 0xA9, 0xA4, 0x66, 0xA9, 0xA4, 0x86,   // 5
0xA8, 0xC4, 0x06, 0xA8, 0xC4, 0x26, 0xA9, 0xC4, 0x46, 0xA9, 0xC4, 0x66,   // 6
0xA9, 0xC4, 0x86, 0xA8, 0xC4, 0x22, 0xA9, 0xC0, 0x22, 0xEB, 0x80, 0x00,   // 7
0x20, 0x20, 0x02, 0x88, 0x40, 0x11, 0xA8, 0x20, 0x62, 0xA8, 0x21, 0xE2,   // 8
0xA8, 0x23, 0x42, 0x07, 0x71, 0x00, 0xB1, 0x10, 0x0C, 0x32, 0x09, 0x00,   // 9
0x20, 0x20, 0x04, 0x88, 0x20, 0x11, 0x20, 0xC0, 0x04, 0x88, 0x20, 0x11,   // 10
0x20, 0x40, 0x03, 0x88, 0x20, 0x11, 0x20, 0xB0, 0x02, 0x88, 0x20, 0x11,   // 11
0x37, 0x73, 0x00, 0x20, 0x40, 0x0D, 0x88, 0x20, 0x11, 0x20, 0x10, 0x00,   // 12
0x88, 0x20, 0x11, 0x20, 0x20, 0x00, 0x88, 0x20, 0x11, 0x20, 0xB0, 0x04,   // 13
0x88, 0x20, 0x11, 0xEB, 0x00, 0x07, 0x07, 0x5C, 0x00, 0x88, 0x90, 0x01,   // 14
0x07, 0x5A, 0x00, 0xB7, 0x03, 0xE1, 0x07, 0x58, 0x00, 0xB7, 0x02, 0xE1,   // 15
0xBF, 0x02, 0x81, 0x78, 0x80, 0x02, 0x78, 0x00, 0x02, 0x07, 0x53, 0x00,   // 16
0x78, 0x80, 0x06, 0x07, 0x51, 0x00, 0x78, 0x80, 0x01, 0x20, 0x02, 0x80,   // 17
0x07, 0x4E, 0x00, 0x78, 0x00, 0x59, 0xE9, 0x83, 0x01, 0x3A, 0xFC, 0xFF,   // 18
0xE0, 0x0E, 0x04, 0x32, 0x03, 0x00, 0x20, 0xE0, 0x04, 0x88, 0x20, 0x11,   // 19
0x37, 0xE8, 0xFF, 0x2A, 0x03, 0x7C, 0xE1, 0x03, 0x28, 0x3E, 0x10, 0x00,   // 20
0xE0, 0x05, 0x00, 0x3A, 0x12, 0x00, 0x20, 0x02, 0x80, 0xB3, 0x40, 0xC0,   // 21
0x78, 0x00, 0x59, 0xB3, 0x00, 0xC0, 0x78, 0x00, 0x59, 0xB3, 0x80, 0xCA,   // 22
0x78, 0x00, 0x59, 0xB3, 0x00, 0xC0, 0x78, 0x00, 0x59, 0xB3, 0x00, 0xC0,   // 23
0x78, 0x00, 0x59, 0xB3, 0x00, 0xC0, 0x78, 0x00, 0x59, 0x37, 0x04, 0x00,   // 24
0xEB, 0x80, 0x00, 0x20, 0x00, 0x05, 0x88, 0x20, 0x11, 0x37, 0xD1, 0xFF,   // 25
0x20, 0x02, 0x80, 0xA7, 0x0D, 0x10, 0x37, 0x02, 0x00, 0x2F, 0xF1, 0xFF,   // 26
0x37, 0xCA, 0xFF, 0xA6, 0x01, 0x00, 0x37, 0x04, 0x00, 0xBB, 0x85, 0x0A,   // 27
0x24, 0x20, 0x04, 0x07, 0x1A, 0x00, 0xEB, 0x80, 0x00, 0x20, 0x03, 0x04,   // 28
0xBB, 0xB2, 0xCA, 0xBB, 0xB2, 0x5A, 0xBB, 0xB2, 0x5A, 0xE9, 0x83, 0x01,   // 29
0x3A, 0xFB, 0xFF, 0x24, 0x10, 0x00, 0x07, 0x11, 0x00, 0x20, 0x03, 0x04,   // 30
0x20, 0x02, 0x80, 0xBA, 0x14, 0xC0, 0xE1, 0x32, 0x04, 0x3A, 0x09, 0x00,   // 31
0xBA, 0x34, 0x40, 0xE1, 0x32, 0x04, 0x3A, 0x06, 0x00, 0xBA, 0x34, 0x40,   // 32
0xE1, 0x32, 0x04, 0x3A, 0x03, 0x00, 0xE9, 0x83, 0x01, 0x3A, 0xF5, 0xFF,   // 33
0x37, 0xAE, 0xFF, 0x20, 0x60, 0x05, 0x88, 0x20, 0x11, 0x37, 0xAD, 0xFF,   // 34
0x88, 0x00, 0x3B, 0x20, 0x50, 0x05, 0x88, 0x30, 0x3B, 0x20, 0xA0, 0x0A,   // 35
0x88, 0x30, 0x3B, 0xA8, 0x61, 0xE7, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // 36
0xAF, 0x61, 0xE7, 0x37, 0xFE, 0xFF, 0x06, 0x00, 0x00, 0x20, 0x1A, 0x01,   // 37
0xEB, 0x80, 0x05, 0xFE, 0x00, 0x60, 0xAE, 0x22, 0x02, 0x37, 0x03, 0x00,   // 38
0x80, 0x30, 0x11, 0x47, 0x00, 0x07, 0x06, 0x00, 0x00, 0xE9, 0x8B, 0x05,   // 39
0x3A, 0xF8, 0xFF, 0xE9, 0x0A, 0x05, 0x3A, 0xF5, 0xFF, 0x20, 0x2F, 0x8C,   // 40
0xA6, 0x08, 0x00, 0xAE, 0xCA, 0x22, 0x37, 0x6A, 0xFF, 0xA9, 0x85, 0x60,   // 41
0xA9, 0x85, 0x80, 0xA9, 0x23, 0x42, 0xA9, 0x21, 0xE2, 0xEF, 0x02, 0x21,   // 42
0xA9, 0xC4, 0x22, 0xA8, 0xC0, 0x22, 0x88, 0x26, 0x35, 0x88, 0x27, 0x36,   // 43
0xA9, 0x68, 0xA0, 0xA8, 0xC8, 0x02, 0x20, 0x00, 0x00, 0x88, 0x60, 0x19,   // 44
0x37, 0x49, 0xFF, 0x2F, 0xF8, 0xFF, 0x37, 0x5A, 0xFF, 0x00, 0x00, 0x08,   // 45
0x00, 0xC2, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0x00, 0x00,   // 46
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 47
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 48
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 49
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 50
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 51
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 52
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 53
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 54
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 55
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 56
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 57
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 58
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 59
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 60
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 61
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 62
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 63
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 64
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 65
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 66
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 67
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 68
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 69
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 70
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 71
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 72
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 73
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 74
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 75
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 76
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 77
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 78
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 79
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 80
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 81
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 82
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 83
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 84
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 85
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 86
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 87
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 88
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 89
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 90
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 91
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 92
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 93
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 94
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 95
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 96
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 97
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 98
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 99
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 100
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 101
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 102
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 103
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 104
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 105
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 106
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 107
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 108
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 109
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 110
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 111
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 112
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 113
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 114
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 115
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 116
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 117
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 118
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 119
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 120
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 121
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 122
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 123
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 124
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 125
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,   // 126
0x37, 0xB8, 0xFE, 0x00, 0x03, 0x04,   // 127
0x00, 0xDF, 0xF9, 0x00, 0x7F, 0x3F,   // 128 (config fuses, stay the same)
};

